---
title: "Correspondence Analysis of Two Mode Networks"
author: "Omar Lizardo"
date: "`r Sys.Date()`"
---

# Setup
```{r setup}
      knitr::opts_chunk$set(include = TRUE, 
                       echo = FALSE, 
                       warning = FALSE, 
                       message = FALSE)
      library(conflicted)
      library(cowplot)
      library(FactoMineR)
      library(ggcorrplot)
      library(ggbump)
      library(ggplot2)
      library(ggpubr)
      library(ggrepel)
      library(here)
      library(factoextra)
      library(igraph)
      library(kableExtra)
      library(networkdata)
      library(pals)
      library(stringr)
      conflicted::conflicts_prefer(dplyr::filter)
```

# Southern Women Data Table
```{r Southern Women Data Matrix}
     A <- as.matrix(as_biadjacency_matrix(southern_women))
     p.names <- str_to_title(rownames(A))
     p.names[which(p.names == "Myrna")] <- "Myra"
     rownames(A) <- p.names
     colnames(A) <- str_replace(colnames(A), "/", "-")
     wlab <- paste("W", 1:18, sep = "")
     wlab <- paste(wlab, rownames(A), sep = " (")
     wlab <- paste(wlab, ")", sep = "")
     elab <- paste("E", 1:14, sep = "")
     elab <- paste(elab, colnames(A), sep = " (")
     elab <- paste(elab, ")", sep = "")
     rownames(A) <- wlab
     colnames(A) <- elab
     p <- ggcorrplot(t(A), colors = c("white", "white", "red")) 
     p <- p + theme(legend.position = "none", 
                  axis.text.y = element_text(size = 16),
                  axis.text.x = element_text(size = 16, angle = 45, hjust = -0.2),
                  )
     p <- p + scale_x_discrete(position = "top") 
     p <- p + scale_y_discrete(limits = rev)
     jpeg(file = here("Plots", "southern-women.jpg"), width=800, height=800)
     p
     dev.off()
```

```{r CA of Aaffiliation Matrix}
   ca.res <- CA(A, graph = FALSE)
   plot.dat <- data.frame(rbind(ca.res$row$coord, ca.res$col$coord)[, 1:2])
   plot.dat <- cbind(plot.dat, mode = c(rep(1, 18), rep(2, 14)), names = rownames(plot.dat))
   p <- ggplot(plot.dat, aes(y = Dim.2, x = Dim.1, 
                             color = factor(mode), label = names))
   p <- p + geom_vline(xintercept = 0, color = "gray")
   p <- p + geom_hline(yintercept = 0, color = "gray")
   p <- p + geom_text_repel(size = 4, max.overlaps = 50)
   p <- p + theme_minimal() 
   p <- p + theme(legend.position = "none",
                  axis.text = element_text(size = 18),
                  axis.title = element_text(size = 20)
                  )
   p <- p + labs(x = "Second Dimension", y = "First Dimension")
   p <- p + scale_color_manual(values = c('red', 'blue'))
   png(file = here("Plots", "ca-southern-women.png"), width=600, height=625)
   p
   dev.off()
```

```{r Reflections Bump Chart (Persons)}
   source(here("Functions", "reflections.R"))
   source(here("Functions", "ref.long.dat.R"))
   evens <- function(x) subset(x, x %% 2 == 0)
   odds <- function(x) subset(x, x %% 2 != 0)
   a <- reflections(A, iter = 26)
   p.e.r <- a$p.r[, evens(1:20)]
   g.e.r <- a$g.r[, evens(1:20)]
   b <- ref.long.dat(a = p.e.r, b = g.e.r, max.iter = 26)
   plot.dat <- b$person
   p <- ggplot(data = filter(plot.dat, n.iter < 18),
               mapping = aes(x = n.iter, y = ref, color = person))
   # geoms
   p <- p + geom_bump(linewidth = 1.1, smooth = 8)
   p <- p + geom_point(size = 5)
   p <- p + geom_text_repel(data = filter(plot.dat, n.iter == 2), 
                                    aes(x = n.iter, label = person), 
                                    size = 5, nudge_x = -3)
   p <-    p <- p + geom_text_repel(data = filter(plot.dat, n.iter == 18), 
                              aes(x = n.iter, label = person), 
                              size = 5, nudge_x = 0.01)

   # fixings
   p <- p + theme_minimal_grid(font_size = 14, line_size = 0)
   p <- p + scale_x_continuous(limits = c(-2, 20), breaks = evens(2:16))
   p <- p + labs(x = "Reflection")
   p <- p + scale_y_reverse()
   p <- p + theme(legend.position = "none",
        panel.grid.major = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 16)
        )
   set.seed(145)
   c <- sample(cols25(25), 18, replace = FALSE)
   p1 <- p + scale_color_manual(values=as.vector(c))
   png(file = here("Plots", "p-reflections.png"), width=600, height=625)
   p1
   dev.off()
```

```{r Reflections Bump Chart (Groups)}
   plot.dat <- b$group
   p <- ggplot(data = filter(plot.dat, n.iter < 14),
               mapping = aes(x = n.iter, y = ref, color = group))
   #geoms
   p <- p + geom_bump(linewidth = 1.1, smooth = 8)
   p <- p + geom_point(size = 5)
   p <- p + geom_text_repel(data = filter(plot.dat, n.iter == 2), 
                                    aes(x = n.iter, label = group), 
                                    size = 6, nudge_x = -1)
   p <- p + geom_text_repel(data = filter(plot.dat, n.iter == 14), 
                              aes(x = n.iter, label = group), 
                              size = 6, nudge_x = -0.01)
   #fixings
   p <- p + theme_minimal_grid(font_size = 14, line_size = 0)
   p <- p + scale_x_continuous(limits = c(1, 14), breaks = evens(2:12))
   p <- p + labs(x = "Reflection")
   p <- p + scale_y_reverse()
   p <- p + theme(legend.position = "none",
        panel.grid.major = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 16)
        )
   set.seed(145)
   c <- sample(cols25(25), 18, replace = FALSE)
   p2 <- p + scale_color_manual(values=as.vector(c))
   png(file = here("Plots", "g-reflections.png"), width=600, height=625)
   p2
   dev.off()
```

```{r CA versus Reflections Scatter}
   source(here("Functions", "TwoModeEig.R"))
   tm <- TwoModeEig(A)
   p.plot.dat <- data.frame(c = tm$ca.eigvec.r[, 1]*-1, r = a$p.s[, 26])
   p <- ggplot(data = p.plot.dat, aes(x = c, y = r))
   p <- p + geom_point(size = 3, color = "blue") 
   p <- p + geom_smooth(method = "lm", se=FALSE, formula = y ~ x, color = "gray")
   p <- p + geom_text_repel(aes(label = rownames(p.plot.dat)), color = "red")
   p <- p + theme_minimal() + labs(x = "First CA Dimension", y = "26th Reflection (Standardized)")
   p <- p + theme(axis.text = element_text(size = 16),
                  axis.title = element_text(size = 16))
   png(file = here("Plots", "p-ca-ref-corr.png"), width=600, height=625)
   p
   dev.off()

   g.plot.dat <- data.frame(cbind(c = tm$ca.eigvec.c[, 1]*-1, 
                                  r = a$g.s[, 26]))
   p <- ggplot(data = g.plot.dat, aes(x = c, y = r))
   p <- p + geom_point(size = 3, color = "red") 
   p <- p + geom_smooth(method = "lm", se=FALSE, formula = y ~ x, color = "gray")
   p <- p + geom_text_repel(aes(label = rownames(g.plot.dat)), 
                            color = "blue", size = 6)
   p <- p + theme_minimal() + labs(x = "First CA Dimension", y = "26th Reflection (Standardized)")
   p <- p + theme(axis.text = element_text(size = 16),
                  axis.title = element_text(size = 16))
   png(file = here("Plots", "g-ca-ref-corr.png"), width=600, height=625)
   p
   dev.off()
```

```{r CA versus Bonacich Re-ordered Affiliation Matrices}
   a <- TwoModeCA(A)
   b <- a$ca.A
   c <- a$bon.A
   png(file = here("Plots", "ca-reord.png"), width=500, height=500)
   b
   dev.off() 
   png(file = here("Plots", "bon-reord.png"), width=500, height=500)
   c
   dev.off() 
```
